<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pandemic Hubs Optimizer</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121a33;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #7c3aed;
      --chip: #1f2b4d;
      --ok: #16a34a;
      --warn: #f59e0b;
      --err: #ef4444;
      --blue: #60a5fa;   /* board colors */
      --yellow: #facc15;
      --black: #a3a3a3;
      --red: #f87171;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text); background: linear-gradient(180deg, #0b1020, #0d1228 60%, #0a0f22);
    }
    header { padding: 20px 16px; text-align: center; }
    h1 { margin: 0; font-size: 1.6rem; letter-spacing: .3px; }
    .container { display: grid; grid-template-columns: 340px 1fr; gap: 16px; padding: 12px 16px 32px; max-width: 1200px; margin: 0 auto; }
    .card { background: var(--panel); border: 1px solid #1f2a44; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.3); }
    .card h2 { font-size: 1rem; font-weight: 600; padding: 16px; margin: 0; border-bottom: 1px solid #1e293b; }
    .card .body { padding: 14px 16px 16px; }
    label { display:block; font-size:.9rem; color: var(--muted); margin: 12px 0 6px; }
    input[type=number], select, button { width: 100%; }
    input[type=number], select { background: #0c142b; color: var(--text); border: 1px solid #24314f; border-radius: 10px; padding: 10px 12px; font-size: .95rem; }
    select[multiple] { min-height: 220px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    button { background: var(--accent); border: none; color: white; padding: 12px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 12px; }
    button.secondary { background: #223057; }
    button.ghost { background: transparent; border: 1px solid #2a365d; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .chips { display:flex; flex-wrap: wrap; gap: 8px; }
    .chip { background: var(--chip); padding: 6px 10px; border-radius: 999px; font-size:.85rem; border:1px solid #30406e; }
    .chip .badge { display:inline-block; width:.75rem; height:.75rem; border-radius:999px; margin-right:6px; vertical-align: -2px; }
    .grid { width: 100%; overflow:auto; border-radius: 12px; border:1px solid #1e293b; }
    table { border-collapse: collapse; width:100%; font-size:.92rem; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #1e293b; }
    tr:nth-child(odd) td { background: #0c142b; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .small { font-size: .85rem; color: var(--muted); }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #334155; }
    footer { text-align:center; padding: 20px; color: #94a3b8; font-size:.85rem; }
  </style>
</head>
<body>
<header>
  <h1>Pandemic Hubs Optimizer (Client‑side, Static)</h1>
  <div class="small">Pick <b>k</b> hubs (with optional pre‑opened hubs) to minimize the sum of <i>squared</i> shortest‑path distances on the Pandemic map.</div>
</header>
<div class="container">
  <section class="card">
    <h2>Controls</h2>
    <div class="body">
      <label for="k">Number of hubs (k)</label>
      <input id="k" type="number" min="1" max="20" step="1" value="3" />

      <label for="preopen">Pre‑open hubs (hold Ctrl/Cmd to multi‑select)</label>
      <select id="preopen" multiple></select>

      <div class="row">
        <button id="run">Compute hubs (Greedy + 1‑Swap)</button>
        <button class="secondary" id="clearSel" type="button">Clear selection</button>
      </div>
      <div class="row">
        <button class="ghost" id="downloadCsv" type="button" disabled>Download assignments CSV</button>
        <button class="ghost" id="downloadJson" type="button" disabled>Download result JSON</button>
      </div>
      <div class="small" style="margin-top:8px">All computation is local. Graph is unweighted and undirected. Complexity is tiny (48 cities).</div>
    </div>
  </section>

  <section class="card">
    <h2>Result</h2>
    <div class="body">
      <div id="summary" class="small">Run the optimizer to see hubs, cost, and assignments.</div>
      <div id="hubs" class="chips" style="margin-top:10px"></div>
      <div class="grid" style="margin-top:12px">
        <table id="table">
          <thead>
            <tr>
              <th class="mono">id</th>
              <th>city</th>
              <th>color</th>
              <th>nearest hub</th>
              <th class="mono">distance</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</div>
<footer>Built for static GitHub Pages. No external libraries, no tracking.</footer>

<script>
// --- Data ------------------------------------------------------------------
// Canonical city data (base Pandemic / Legacy S1 starting map).
const CITY_DATA = {
  "Atlanta": {color: "blue", links: ["Miami","Chicago","Montreal","Washington"]},
  "New York": {color: "blue", links: ["Washington","London","Montreal","Madrid"]},
  "Chennai": {color: "black", links: ["Mumbai","Kolkata","Delhi","Bangkok","Jakarta"]},
  "Buenos Aires": {color: "yellow", links: ["Bogota","Sao Paulo"]},
  "Tokyo": {color: "red", links: ["Seoul","Osaka","Shanghai","San Francisco"]},
  "Paris": {color: "blue", links: ["Madrid","London","Essen","Milan","Algiers"]},
  "Ho Chi Minh City": {color: "red", links: ["Jakarta","Bangkok","Hong Kong","Manila"]},
  "Johannesburg": {color: "yellow", links: ["Kinshasa","Khartoum"]},
  "Seoul": {color: "red", links: ["Tokyo","Shanghai","Beijing"]},
  "Taipei": {color: "red", links: ["Manila","Hong Kong","Shanghai","Osaka"]},
  "Chicago": {color: "blue", links: ["San Francisco","Los Angeles","Mexico City","Atlanta","Montreal"]},
  "Tehran": {color: "black", links: ["Delhi","Karachi","Baghdad","Moscow"]},
  "Cairo": {color: "black", links: ["Algiers","Istanbul","Baghdad","Riyadh","Khartoum"]},
  "Karachi": {color: "black", links: ["Tehran","Delhi","Mumbai","Riyadh","Baghdad"]},
  "Bogota": {color: "yellow", links: ["Miami","Sao Paulo","Buenos Aires","Lima","Mexico City"]},
  "Lima": {color: "yellow", links: ["Santiago","Mexico City","Bogota"]},
  "Manila": {color: "red", links: ["San Francisco","Sydney","Ho Chi Minh City","Hong Kong","Taipei"]},
  "Beijing": {color: "red", links: ["Shanghai","Seoul"]},
  "Washington": {color: "blue", links: ["Miami","Atlanta","Montreal","New York"]},
  "Moscow": {color: "black", links: ["St. Petersburg","Tehran","Istanbul"]},
  "Milan": {color: "blue", links: ["Paris","Essen","Istanbul"]},
  "Miami": {color: "yellow", links: ["Atlanta","Washington","Bogota","Mexico City"]},
  "Jakarta": {color: "red", links: ["Chennai","Bangkok","Ho Chi Minh City","Sydney"]},
  "Sao Paulo": {color: "yellow", links: ["Buenos Aires","Bogota","Madrid","Lagos"]},
  "Madrid": {color: "blue", links: ["New York","London","Paris","Algiers","Sao Paulo"]},
  "Mexico City": {color: "yellow", links: ["Los Angeles","Chicago","Miami","Bogota","Lima"]},
  "Delhi": {color: "black", links: ["Kolkata","Chennai","Mumbai","Karachi","Tehran"]},
  "Kinshasa": {color: "yellow", links: ["Lagos","Khartoum","Johannesburg"]},
  "Santiago": {color: "yellow", links: ["Lima"]},
  "Algiers": {color: "black", links: ["Madrid","Paris","Istanbul","Cairo"]},
  "Montreal": {color: "blue", links: ["New York","Washington","Chicago"]},
  "Lagos": {color: "yellow", links: ["Sao Paulo","Khartoum","Kinshasa"]},
  "Sydney": {color: "red", links: ["Jakarta","Manila","Los Angeles"]},
  "Shanghai": {color: "red", links: ["Beijing","Seoul","Tokyo","Taipei","Hong Kong"]},
  "St. Petersburg": {color: "blue", links: ["Moscow","Istanbul","Essen"]},
  "Bangkok": {color: "red", links: ["Chennai","Kolkata","Hong Kong","Ho Chi Minh City","Jakarta"]},
  "Baghdad": {color: "black", links: ["Istanbul","Tehran","Karachi","Riyadh","Cairo"]},
  "Essen": {color: "blue", links: ["St. Petersburg","Milan","Paris","London"]},
  "Istanbul": {color: "black", links: ["Milan","Moscow","Baghdad","Cairo","Algiers","St. Petersburg"]},
  "Osaka": {color: "red", links: ["Tokyo","Taipei"]},
  "Los Angeles": {color: "yellow", links: ["Sydney","San Francisco","Chicago","Mexico City"]},
  "Khartoum": {color: "yellow", links: ["Cairo","Johannesburg","Kinshasa","Lagos"]},
  "Riyadh": {color: "black", links: ["Cairo","Baghdad","Karachi"]},
  "London": {color: "blue", links: ["Essen","Paris","Madrid","New York"]},
  "Kolkata": {color: "black", links: ["Hong Kong","Bangkok","Chennai","Delhi"]},
  "San Francisco": {color: "blue", links: ["Tokyo","Manila","Los Angeles","Chicago"]},
  "Mumbai": {color: "black", links: ["Karachi","Delhi","Chennai"]},
  "Hong Kong": {color: "red", links: ["Shanghai","Taipei","Manila","Ho Chi Minh City","Bangkok","Kolkata"]}
};
const COLOR_CODE = { blue: "#60a5fa", yellow: "#facc15", black: "#a3a3a3", red: "#f87171" };
const COLOR_ID = { blue: 0, yellow: 1, black: 2, red: 3 };

function orderByColor() {
  const groups = { blue: [], yellow: [], black: [], red: [] };
  Object.entries(CITY_DATA).forEach(([name, meta]) => groups[meta.color].push(name));
  const ordered = [];
  ["blue","yellow","black","red"].forEach(c => ordered.push(...groups[c].sort()));
  return ordered;
}

function buildGraph(orderMode = "by_color") {
  const names = orderMode === "by_color" ? orderByColor() : Object.keys(CITY_DATA).sort();
  const n = names.length;
  const idOf = Object.fromEntries(names.map((c,i)=>[c,i]));
  const colorId = new Array(n);
  const adj = Array.from({length:n}, ()=>new Set());
  names.forEach((city,i)=>{ colorId[i] = COLOR_ID[CITY_DATA[city].color]; });
  names.forEach((city,i)=>{
    for (const nb of CITY_DATA[city].links) {
      const j = idOf[nb];
      adj[i].add(j); adj[j].add(i);
    }
  });
  const adjArr = adj.map(s=>Array.from(s));
  return { n, names, idOf, adj: adjArr, colorId };
}

// --- Shortest paths (unweighted BFS for each source) -----------------------
function allPairsShortestPaths(adj) {
  const n = adj.length;
  const INF = 1e9;
  const D = Array.from({length:n}, ()=>new Array(n).fill(INF));
  for (let s=0;s<n;s++) {
    const q = []; let qh=0; const dist = D[s];
    dist[s]=0; q.push(s);
    while(qh<q.length){
      const u=q[qh++];
      const du=dist[u];
      for(const v of adj[u]){
        if(dist[v]===INF){ dist[v]=du+1; q.push(v); }
      }
    }
  }
  return D;
}

// --- Objective & solvers ---------------------------------------------------
function assignToHubs(D, hubs){
  const n = D.length; const assign = new Array(n).fill(-1); const dist = new Array(n).fill(Infinity);
  for(let i=0;i<n;i++){
    let best = Infinity, bestH=-1;
    for(const h of hubs){
      const d = D[i][h];
      if(d < best){ best=d; bestH=h; }
    }
    assign[i]=bestH; dist[i]=best;
  }
  return {assign, dist};
}
function objectiveSquared(dist){
  let s=0; for(const d of dist){ s += d*d; } return s; // weights=1
}

function greedyAdd(D, k, preopen){
  const n=D.length; const H = new Set(preopen);
  while(H.size<k){
    let bestCity=-1, bestCost=Infinity;
    for(let c=0;c<n;c++) if(!H.has(c)){
      const {dist} = assignToHubs(D, [...H, c]);
      const cost = objectiveSquared(dist);
      if(cost < bestCost){ bestCost=cost; bestCity=c; }
    }
    H.add(bestCity);
  }
  return H;
}

function oneSwapLocalSearch(D, H){
  const n=D.length; let hubs = new Set(H);
  let improved=true;
  while(improved){
    improved=false;
    const base = [...hubs];
    const closed = []; for(let j=0;j<n;j++) if(!hubs.has(j)) closed.push(j);
    let {dist} = assignToHubs(D, base); let bestCost = objectiveSquared(dist);
    outer: for(const h of base){
      for(const c of closed){
        const cand = new Set(hubs); cand.delete(h); cand.add(c);
        const {dist:dist2} = assignToHubs(D, [...cand]);
        const cost2 = objectiveSquared(dist2);
        if(cost2 + 1e-9 < bestCost){ hubs=cand; bestCost=cost2; improved=true; break outer; }
      }
    }
  }
  return hubs;
}

function solveHubs(graph, k, preopenNames){
  const {n, names, idOf, adj, colorId} = graph;
  const preopen = preopenNames.map(nm=>idOf[nm]);
  if(k < preopen.length) throw new Error(`k=${k} is smaller than pre‑open count ${preopen.length}`);
  // All-pairs distances
  const D = allPairsShortestPaths(adj);
  // Greedy add + 1-swap local search
  const greedy = greedyAdd(D, k, preopen);
  const final = oneSwapLocalSearch(D, greedy);
  const hubs = [...final];
  hubs.sort((a,b)=>a-b);
  const {assign, dist} = assignToHubs(D, hubs);
  const cost = objectiveSquared(dist);
  return { hubs, assign, dist, cost, names, idOf, colorId, adj, D };
}

// --- UI --------------------------------------------------------------------
const graph = buildGraph("by_color");
const sel = document.getElementById('preopen');
for(const name of graph.names){
  const opt = document.createElement('option');
  opt.value = name; opt.textContent = `${name}  (#${graph.idOf[name]})`;
  sel.appendChild(opt);
}

function colorName(id){ return Object.keys(COLOR_ID).find(k=>COLOR_ID[k]===id); }
function colorBadgeStyle(id){
  const map={0:'var(--blue)',1:'var(--yellow)',2:'var(--black)',3:'var(--red)'}; return `background:${map[id]}`; }

function render(result){
  const hubsDiv=document.getElementById('hubs'); hubsDiv.innerHTML='';
  const sum=document.getElementById('summary');
  const k=result.hubs.length;
  const chips=[];
  for(const h of result.hubs){
    const chip=document.createElement('div'); chip.className='chip';
    const badge=document.createElement('span'); badge.className='badge'; badge.style= colorBadgeStyle(result.colorId?result.colorId[h]:graph.colorId[h]);
    chip.appendChild(badge);
    chip.appendChild(document.createTextNode(`#${h} ${result.names[h]}`));
    chips.push(chip);
  }
  chips.forEach(c=>hubsDiv.appendChild(c));
  sum.innerHTML = `<div class=small><span class=pill>k=${k}</span> <span class=pill>vertices=${graph.n}</span> <span class=pill>objective ∑d² = <b>${result.cost.toFixed(2)}</b></span></div>`;

  const tbody=document.querySelector('#table tbody'); tbody.innerHTML='';
  for(let i=0;i<graph.n;i++){
    const tr=document.createElement('tr');
    const td0=document.createElement('td'); td0.className='mono'; td0.textContent=i; tr.appendChild(td0);
    const td1=document.createElement('td'); td1.textContent=graph.names[i]; tr.appendChild(td1);
    const td2=document.createElement('td');
      const pill=document.createElement('span'); pill.className='chip';
      const b=document.createElement('span'); b.className='badge'; b.style=colorBadgeStyle(graph.colorId[i]); pill.appendChild(b);
      pill.appendChild(document.createTextNode(colorName(graph.colorId[i])));
      td2.appendChild(pill); tr.appendChild(td2);
    const h=result.assign[i];
    const td3=document.createElement('td'); td3.textContent= `#${h} ${graph.names[h]}`; tr.appendChild(td3);
    const td4=document.createElement('td'); td4.className='mono'; td4.textContent= result.dist[i]; tr.appendChild(td4);
    tbody.appendChild(tr);
  }
}

function getSelectedPreopen(){
  return Array.from(sel.selectedOptions).map(o=>o.value);
}

document.getElementById('run').addEventListener('click', ()=>{
  const k = parseInt(document.getElementById('k').value,10);
  const pre = getSelectedPreopen();
  try {
    const res = solveHubs(graph, k, pre);
    render(res);
    // Enable downloads
    document.getElementById('downloadCsv').disabled=false;
    document.getElementById('downloadJson').disabled=false;
    window.__lastResult = res;
  } catch(e){
    alert(e.message);
  }
});

document.getElementById('clearSel').addEventListener('click', ()=>{
  Array.from(sel.options).forEach(o=>o.selected=false);
});

function download(filename, text, mime){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([text],{type:mime||'text/plain'}));
  a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

document.getElementById('downloadCsv').addEventListener('click', ()=>{
  const r = window.__lastResult; if(!r) return;
  let csv = 'id,city,color,assigned_hub_id,assigned_hub,dist\n';
  for(let i=0;i<graph.n;i++){
    csv += `${i},${graph.names[i]},${colorName(graph.colorId[i])},${r.assign[i]},${graph.names[r.assign[i]]},${r.dist[i]}\n`;
  }
  csv += `objective_sum_sq,, , , ,${r.cost}\n`;
  download('pandemic_hub_assignments.csv', csv, 'text/csv');
});

document.getElementById('downloadJson').addEventListener('click', ()=>{
  const r = window.__lastResult; if(!r) return;
  const out = {
    k: r.hubs.length,
    hubs: r.hubs.map(id=>({id, city: r.names[id]})),
    objective_sum_squared: r.cost,
    assignments: Array.from({length:graph.n}, (_,i)=>({
      id: i, city: r.names[i], color: colorName(graph.colorId[i]), hub_id: r.assign[i], hub: r.names[r.assign[i]], dist: r.dist[i]
    }))
  };
  download('pandemic_hub_result.json', JSON.stringify(out, null, 2), 'application/json');
});
</script>
</body>
</html>
